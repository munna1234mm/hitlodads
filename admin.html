<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Emerald Admin Panel</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10b981",
                        "secondary": "#064e3b",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .emerald-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .premium-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.05);
        }

        .emerald-bg {
            background-color: #10b981;
        }
    </style>
</head>

<body class="bg-background-light text-slate-800 font-display min-h-screen">
    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-full lg:w-72 bg-white border-r border-slate-200 p-6 flex flex-col gap-8">
            <div class="flex items-center gap-3">
                <div
                    class="size-10 emerald-gradient rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                    <span class="material-symbols-outlined text-white font-bold">shield</span>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight text-slate-900 leading-none">VIP EMERALD</h1>
                    <p class="text-[10px] text-primary font-bold uppercase tracking-[0.2em] mt-1">Management Portal</p>
                </div>
            </div>

            <nav class="flex flex-col gap-2">
                <a href="#stats"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary/5 text-primary font-bold">
                    <span class="material-symbols-outlined text-xl">dashboard</span>
                    Stats & Analytics
                </a>
                <a href="#withdrawals"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-all">
                    <span class="material-symbols-outlined text-xl">payments</span>
                    Withdrawal Quota
                </a>
                <a href="#users"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-all">
                    <span class="material-symbols-outlined text-xl">group</span>
                    User Database
                </a>
                <a href="#settings"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-all">
                    <span class="material-symbols-outlined text-xl">settings</span>
                    Global Core
                </a>
            </nav>

            <div class="mt-auto p-4 rounded-2xl bg-slate-900 text-white">
                <div class="flex items-center gap-2 mb-2">
                    <div id="status-dot" class="size-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold uppercase tracking-widest text-emerald-500"
                        id="status-text">System Live</span>
                </div>
                <p class="text-[11px] text-slate-400 font-medium">Firebase DB Synchronized</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-10 overflow-y-auto max-h-screen no-scrollbar">
            <!-- Stats Overview -->
            <section id="stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="premium-card p-6 border-l-4 border-emerald-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Total Members</p>
                    <div class="flex items-end justify-between">
                        <h3 id="stat-total-users" class="text-4xl font-black text-slate-900">0</h3>
                        <span class="material-symbols-outlined text-emerald-500 text-3xl opacity-20">group</span>
                    </div>
                </div>
                <div class="premium-card p-6 border-l-4 border-emerald-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Total Payouts (BDT)
                    </p>
                    <div class="flex items-end justify-between">
                        <h3 id="stat-total-balance" class="text-4xl font-black text-slate-900">0.00</h3>
                        <span class="material-symbols-outlined text-emerald-500 text-3xl opacity-20">payments</span>
                    </div>
                </div>
                <div class="premium-card p-6 border-l-4 border-emerald-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Total VIP Tokens</p>
                    <div class="flex items-end justify-between">
                        <h3 id="stat-total-tokens" class="text-4xl font-black text-slate-900">0</h3>
                        <span class="material-symbols-outlined text-emerald-500 text-3xl opacity-20">token</span>
                    </div>
                </div>
                <div class="premium-card p-6 border-l-4 border-emerald-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Banned Entities</p>
                    <div class="flex items-end justify-between">
                        <h3 id="stat-banned-users" class="text-4xl font-black text-slate-900">0</h3>
                        <span class="material-symbols-outlined text-red-500 text-3xl opacity-20">block</span>
                    </div>
                </div>
            </section>

            <!-- Withdrawal Requests Section -->
            <section id="withdrawals" class="mb-10">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <span
                            class="material-symbols-outlined text-emerald-600 font-bold p-2 bg-emerald-100 rounded-xl">account_balance_wallet</span>
                        <h2 class="text-2xl font-black uppercase tracking-tight">Withdrawal Ledger</h2>
                    </div>
                    <span id="payout-status"
                        class="text-[10px] font-bold px-3 py-1 bg-slate-100 rounded-full uppercase tracking-widest text-slate-500">Processing
                        Queue</span>
                </div>

                <div class="premium-card overflow-hidden border border-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Member</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Method & Number</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Amount (BDT)</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Requested At</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawal-list" class="divide-y divide-slate-100">
                                <!-- Requests dynamically filled -->
                                <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-slate-400 italic">Synchronizing
                                        ledger...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Task Management Section -->
            <section id="tasks" class="mb-10">
                <div class="flex items-center gap-3 mb-6">
                    <span
                        class="material-symbols-outlined text-indigo-600 font-bold p-2 bg-indigo-100 rounded-xl">add_task</span>
                    <h2 class="text-2xl font-black uppercase tracking-tight text-slate-900">Task Creator</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div class="lg:col-span-1">
                        <div class="premium-card p-8 border border-slate-200 shadow-xl">
                            <div class="space-y-4">
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Task
                                        Title</label>
                                    <input type="text" id="task-title" placeholder="e.g. Join Telegram"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Reward
                                        (BDT)</label>
                                    <input type="number" id="task-reward" placeholder="10.00"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Type</label>
                                    <select id="task-type"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                                        <option value="telegram">Telegram</option>
                                        <option value="youtube">YouTube</option>
                                        <option value="twitter">X (Twitter)</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">External
                                        URL</label>
                                    <input type="text" id="task-url" placeholder="https://..."
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                                </div>
                                <button onclick="createTask()"
                                    class="w-full bg-indigo-600 text-white font-bold uppercase tracking-widest text-[11px] py-4 rounded-xl shadow-lg shadow-indigo-200 hover:scale-[1.02] transition-all mt-4">
                                    Publish New Task
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="premium-card overflow-hidden border border-slate-200 h-full">
                            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
                                <h3 class="text-xs font-bold uppercase text-slate-500 tracking-widest">Active Task
                                    Directory</h3>
                            </div>
                            <div id="tasks-list"
                                class="divide-y divide-slate-100 max-h-[400px] overflow-y-auto no-scrollbar">
                                <!-- Tasks dynamically filled -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings & Config -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <!-- Global Config -->
                <section id="settings">
                    <div class="flex items-center gap-3 mb-6">
                        <span
                            class="material-symbols-outlined text-emerald-600 font-bold p-2 bg-emerald-100 rounded-xl">tune</span>
                        <h2 class="text-2xl font-black uppercase tracking-tight text-slate-900">System Parameters</h2>
                    </div>

                    <div class="premium-card p-8 border border-slate-200 shadow-xl">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">System
                                        Commission (%)</label>
                                    <input type="number" id="global-commission"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Token
                                        Identity Name</label>
                                    <input type="text" id="global-token-name"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Spin
                                        Yield (Tokens)</label>
                                    <input type="number" id="global-spin-reward"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Math
                                        Duel Yield (Tokens)</label>
                                    <input type="number" id="global-math-reward"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Daily
                                        Spin Quota</label>
                                    <input type="number" id="global-spin-limit"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Daily
                                        Math Quota</label>
                                    <input type="number" id="global-math-limit"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Min
                                        Withdrawal (BDT)</label>
                                    <input type="number" id="global-min-withdraw"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500">
                                </div>
                            </div>

                            <div class="pt-6 border-t border-slate-100 flex justify-end">
                                <button onclick="saveGlobalSettings()"
                                    class="emerald-gradient text-white font-bold uppercase tracking-[0.2em] text-[11px] px-8 py-4 rounded-xl shadow-lg hover:scale-[1.02] transition-all">
                                    Commit Global Updates
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Ad Config -->
                <section>
                    <div class="flex items-center gap-3 mb-6">
                        <span
                            class="material-symbols-outlined text-indigo-600 font-bold p-2 bg-indigo-100 rounded-xl">campaign</span>
                        <h2 class="text-2xl font-black uppercase tracking-tight text-slate-900">Revenue Stream</h2>
                    </div>

                    <div class="premium-card p-8 border border-slate-200 shadow-xl bg-indigo-50/20">
                        <div class="space-y-6">
                            <div>
                                <label
                                    class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Moneytag
                                    Script Endpoint (Tag or URL)</label>
                                <input type="text" id="moneytag-script"
                                    placeholder="<script src='//libtl.com/sdk.js' data-zone='123' data-sdk='show_123'></script>"
                                    class="w-full bg-white border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                                <p class="text-[9px] text-slate-400 mt-1 pl-2 italic">Example: &lt;script
                                    src='//libtl.com/sdk.js' data-zone='10658939'
                                    data-sdk='show_10658939'&gt;&lt;/script&gt;</p>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">Moneytag
                                    Target Tag ID</label>
                                <input type="text" id="moneytag-tag-id"
                                    class="w-full bg-white border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase tracking-widest pl-2">VIP
                                    Support Access Link</label>
                                <input type="text" id="global-support-link"
                                    class="w-full bg-white border-slate-200 rounded-xl px-4 py-3 focus:ring-indigo-500">
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- User Database Section -->
            <section id="users" class="mt-16 mb-20">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3 text-slate-900">
                        <span
                            class="material-symbols-outlined font-bold p-2 bg-slate-100 rounded-xl">person_search</span>
                        <h2 class="text-2xl font-black uppercase tracking-tight">Access Control</h2>
                    </div>
                    <div class="flex items-center bg-white border border-slate-200 rounded-xl px-4 py-2">
                        <span class="material-symbols-outlined text-slate-400 text-sm">search</span>
                        <input type="text" id="user-search" placeholder="Search Member ID / Name..."
                            class="border-none focus:ring-0 text-xs w-48">
                    </div>
                </div>

                <div class="premium-card overflow-hidden border border-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Identify</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Fiat (BDT)</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        VIP Tokens</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Access Key</th>
                                    <th
                                        class="px-6 py-4 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                                        Control</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-slate-100">
                                <!-- Users dynamically filled -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let allUsers = {};
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');

        function loadDashboard() {
            // Load users
            db.ref('users').on('value', (snapshot) => {
                allUsers = snapshot.val() || {};
                updateStats();
                renderUserTable();
                statusText.innerText = "Synchronized";
                statusDot.classList.remove('bg-red-500');
                statusDot.classList.add('bg-emerald-500');
            }, (error) => {
                statusText.innerText = "Sync Error";
                statusDot.classList.add('bg-red-500');
            });

            // Load global settings
            db.ref('settings').on('value', (snapshot) => {
                const settings = snapshot.val() || {};
                document.getElementById('global-commission').value = settings.globalCommission || 0;
                document.getElementById('global-token-name').value = settings.tokenName || '';
                document.getElementById('global-spin-reward').value = settings.spinReward || 0;
                document.getElementById('global-math-reward').value = settings.mathReward || 0;
                document.getElementById('global-spin-limit').value = settings.dailySpinLimit || 0;
                document.getElementById('global-math-limit').value = settings.dailyMathLimit || 0;
                document.getElementById('global-min-withdraw').value = settings.minWithdraw || 200;
                document.getElementById('moneytag-script').value = settings.moneytagScript || '';
                document.getElementById('moneytag-tag-id').value = settings.moneytagTagId || '';
                document.getElementById('global-support-link').value = settings.supportLink || '';
            });

            // Load tasks
            db.ref('tasks').on('value', (snapshot) => {
                const tasks = snapshot.val() || {};
                renderTasks(tasks);
            });

            // Load withdrawals
            db.ref('withdrawals').on('value', (snapshot) => {
                const requests = snapshot.val() || {};
                renderWithdrawals(requests);
            });
        }

        function renderTasks(tasks) {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';

            Object.entries(tasks).forEach(([tid, t]) => {
                const div = document.createElement('div');
                div.className = 'px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition-all';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="size-10 bg-slate-100 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-slate-400 text-xl">
                                ${t.type === 'telegram' ? 'send' : (t.type === 'youtube' ? 'play_circle' : (t.type === 'twitter' ? 'rebase' : 'link'))}
                            </span>
                        </div>
                        <div>
                            <p class="text-xs font-black text-slate-800">${t.title}</p>
                            <p class="text-[10px] font-bold text-primary">${t.reward} BDT â€¢ <span class="uppercase">${t.type}</span></p>
                        </div>
                    </div>
                    <button onclick="deleteTask('${tid}')" class="p-2 text-slate-300 hover:text-red-500 transition-all">
                        <span class="material-symbols-outlined text-xl">delete</span>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function createTask() {
            const title = document.getElementById('task-title').value.trim();
            const reward = parseFloat(document.getElementById('task-reward').value);
            const type = document.getElementById('task-type').value;
            const url = document.getElementById('task-url').value.trim();

            if (!title || isNaN(reward) || !url) return alert("Please fill all task fields correctly.");

            const newTaskRef = db.ref('tasks').push();
            newTaskRef.set({
                title,
                reward,
                type,
                url,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('task-title').value = '';
                document.getElementById('task-reward').value = '';
                document.getElementById('task-url').value = '';
            });
        }

        function deleteTask(tid) {
            if (confirm("Permanently delete this task?")) {
                db.ref(`tasks/${tid}`).remove();
            }
        }

        function updateStats() {
            let totalUsers = Object.keys(allUsers).length;
            let totalBalance = 0;
            let totalTokens = 0;
            let bannedUsers = 0;

            Object.values(allUsers).forEach(u => {
                totalBalance += (u.balance || 0);
                totalTokens += (u.tokens || 0);
                if (u.isBanned) bannedUsers++;
            });

            document.getElementById('stat-total-users').innerText = totalUsers;
            document.getElementById('stat-total-balance').innerText = totalBalance.toLocaleString(undefined, { minimumFractionDigits: 2 });
            document.getElementById('stat-total-tokens').innerText = totalTokens.toLocaleString();
            document.getElementById('stat-banned-users').innerText = bannedUsers;
        }

        function renderUserTable() {
            const body = document.getElementById('user-table-body');
            body.innerHTML = '';
            const query = document.getElementById('user-search').value.toLowerCase();

            Object.entries(allUsers).forEach(([uid, u]) => {
                if (query && !u.id?.toString().includes(query) && !u.name?.toLowerCase().includes(query)) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <img src="${u.photo_url || 'https://via.placeholder.com/40'}" class="size-10 rounded-full border-2 border-slate-100">
                            <div>
                                <p class="text-sm font-bold text-slate-900 leading-tight">${u.name || 'Anonymous'}</p>
                                <p class="text-[10px] text-slate-400 font-medium">ID: ${u.id || uid}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">${(u.balance || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 font-bold text-primary">${(u.tokens || 0).toLocaleString()}</td>
                    <td class="px-6 py-4">
                        <span class="text-[9px] font-black p-1 bg-slate-100 rounded border border-slate-200 uppercase">${u.isBanned ? 'LOCKED' : 'ACTIVE'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick="toggleBan('${uid}', ${u.isBanned})" class="p-2 ${u.isBanned ? 'text-emerald-500 bg-emerald-50' : 'text-red-500 bg-red-50'} rounded-lg transition-all">
                                <span class="material-symbols-outlined text-xl">${u.isBanned ? 'lock_open' : 'lock_reset'}</span>
                            </button>
                            <button onclick="editBalance('${uid}')" class="p-2 text-indigo-500 bg-indigo-50 rounded-lg">
                                <span class="material-symbols-outlined text-xl">payments</span>
                            </button>
                        </div>
                    </td>
                `;
                body.appendChild(row);
            });
        }

        function renderWithdrawals(requests) {
            const body = document.getElementById('withdrawal-list');
            body.innerHTML = '';

            const entries = Object.entries(requests).reverse(); // Newest first

            if (entries.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-400 italic">No pending requests found.</td></tr>';
                return;
            }

            entries.forEach(([id, req]) => {
                const row = document.createElement('tr');
                const statusColor = req.status === 'approved' ? 'text-emerald-500 bg-emerald-50' : (req.status === 'rejected' ? 'text-red-500 bg-red-50' : 'text-amber-500 bg-amber-50');

                row.className = req.status !== 'pending' ? 'opacity-50 grayscale' : '';
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div>
                            <p class="text-[11px] font-bold text-slate-900">${req.userName}</p>
                            <p class="text-[9px] text-slate-400">UID: ${req.userId}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                             <span class="px-2 py-0.5 rounded-md bg-slate-100 text-[10px] font-bold uppercase border border-slate-200">${req.method}</span>
                             <p class="text-xs font-bold text-slate-700 font-mono tracking-tight">${req.number}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-black">${req.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 text-[10px] text-slate-500">${new Date(req.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4">
                        ${req.status === 'pending' ? `
                            <div class="flex gap-2">
                                <button onclick="updateWithdrawal('${id}', 'approved')" class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-[10px] font-bold uppercase shadow-sm shadow-emerald-200">Approve</button>
                                <button onclick="updateWithdrawal('${id}', 'rejected')" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-[10px] font-bold uppercase shadow-sm shadow-red-200">Reject</button>
                            </div>
                        ` : `<span class="px-3 py-1.5 rounded-md text-[10px] font-black uppercase ${statusColor}">${req.status}</span>`}
                    </td>
                `;
                body.appendChild(row);
            });
        }

        async function updateWithdrawal(id, status) {
            if (!confirm(`Mark this request as ${status.toUpperCase()}?`)) return;
            try {
                await db.ref(`withdrawals/${id}`).update({ status: status });
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function saveGlobalSettings() {
            const settings = {
                globalCommission: parseInt(document.getElementById('global-commission').value) || 0,
                tokenName: document.getElementById('global-token-name').value.trim(),
                spinReward: parseInt(document.getElementById('global-spin-reward').value) || 0,
                mathReward: parseInt(document.getElementById('global-math-reward').value) || 0,
                dailySpinLimit: parseInt(document.getElementById('global-spin-limit').value) || 0,
                dailyMathLimit: parseInt(document.getElementById('global-math-limit').value) || 0,
                minWithdraw: parseInt(document.getElementById('global-min-withdraw').value) || 200,
                moneytagScript: document.getElementById('moneytag-script').value.trim(),
                moneytagTagId: document.getElementById('moneytag-tag-id').value.trim(),
                supportLink: document.getElementById('global-support-link').value.trim(),
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('settings').update(settings).then(() => {
                alert("Core System Updated Successfully!");
            });
        }

        function toggleBan(uid, current) {
            if (!confirm(`Confirm ${current ? 'UNBAN' : 'BAN'} for user ${uid}?`)) return;
            db.ref(`users/${uid}`).update({ isBanned: !current });
        }

        function editBalance(uid) {
            const amt = prompt("Enter new Balance for this user (BDT):", allUsers[uid].balance || 0);
            if (amt !== null) {
                db.ref(`users/${uid}`).update({ balance: parseFloat(amt) });
            }
        }

        document.getElementById('user-search').oninput = renderUserTable;

        loadDashboard();
    </script>
</body>

</html>